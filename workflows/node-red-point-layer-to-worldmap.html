<!DOCTYPE html>
<html lang="en-gb">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>OSGS - Node-red point layer to world map</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css" integrity="sha256-NuCn4IvuZXdBaFKJOAcsU2Q3ZpwbdFisd5dux4jkQ5w=" crossorigin="anonymous"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap-theme.css" integrity="sha256-xOpS+e/dER8z72w+qryCieOGysQI8cELAVt3MHG0phY=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tooltipster@4.2.7/dist/css/tooltipster.bundle.min.css" integrity="sha256-Qc4lCfqZWYaHF5hgEOFrYzSIX9Rrxk0NPHRac+08QeQ=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tooltipster@4.2.7/dist/css/plugins/tooltipster/sideTip/themes/tooltipster-sideTip-light.min.css" integrity="sha256-Wa1I4jhSXeWd3N6RhfPlkqr1WlT+zS3Vh2YGCg0129E=" crossorigin="anonymous">
<link href="https://fonts.googleapis.com/css?family=Open+Sans|Source+Code+Pro|Source+Sans+Pro|Source+Serif+Pro|Roboto|Roboto+Mono" rel="stylesheet">
<link href="https://fonts.red-dove.com/iosevka-ss09-regular/webfont.css" rel="stylesheet">

    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/css/sizzle.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/css/sizzle.css" type="text/css" />
    <link rel="stylesheet" href="../_static/css/css.css" type="text/css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.9.1/underscore-min.js" integrity="sha256-G7A4JrJjJlFqP0yamznwPjAApIKPkadeHfyIwiaa9e0=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/tooltipster@4.2.7/dist/js/tooltipster.bundle.min.js" integrity="sha256-NOU7KrY2aTI4PxDegqYUIknk9qfxVCS0E4JfE9aMwaA=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script>
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  false,
        SOURCELINK_SUFFIX: '.txt'
      };
      $(document).data('sizzle', {on_load: []});
    </script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/js/js.js"></script>
      <script src="../../app-data.js"></script>
<link rel="index" title="Index" href="../genindex.html" />
<link rel="search" title="Search" href="../search.html" />
<link rel="next" title="PostgREST API - TODO" href="postgrest-api.html" />
<link rel="prev" title="Node-red workflow that accesses data in Postgres" href="node-red-access-data-in-postgres.html" />

</head>
<body class="full-height test">
<noscript>
  <div>
    <div id="noscript-message">JavaScript is not enabled. It is needed for this website to work.</div>
  </div>
</noscript>
<div id="whole-page" class="container-fluid content full-height">
  <div id="header-row" class="row">
    <div id="header-container" class="col-md-12">
      <div id="hdr-left">
        <i class="fa fa-bars menu-toggle"></i>
        
<a href="../index.html" class="text-logo">OSGS 1.0 documentation</a>

      </div>
      <div id="hdr-centre" class="text-center stretch">
        <h3 title="Node-red point layer to world map">Node-red point layer to world map</h3>
        <h6>Node-red point layer to world map</h6>
      </div>
      <div id="hdr-search">
        
<div class="input-group" title="Enter something to search for and then either press Enter or click the magnifying glass">
  <input type="text" class="form-control search-query" placeholder="Search docs ...">
  <div class="input-group-addon">
    <i class="fa fa-search"></i>
  </div>
</div>
      </div>

      <div id="hdr-source">
        <a href="../_sources/workflows/node-red-point-layer-to-worldmap.md.txt" class="btn btn-default" title="See the source for this page"><i class="fa fa-code"></i></a>
      </div>

      <div id="hdr-right">
        
  
  <div class="prev-next">
    
      <div class="pull-left">
        <a class="btn btn-default prev" href="node-red-access-data-in-postgres.html" title="Previous chapter (Node-red workflow that accesses data in Postgres)"><i class="fa fa-chevron-left mr-1em" aria-hidden="true"></i><span class="btn-text">Node-red workflow that accesses data in Postgres</span></a>
      </div>
    
      <div class="pull-right">
        <a class="btn btn-default next" href="postgrest-api.html" title="Next chapter (PostgREST API - TODO)"><span class="btn-text">PostgREST API - TODO</span>&nbsp;<i class="fa fa-chevron-right ml-1em" aria-hidden="true"></i></a>
      </div>
    </div>
  
      </div>
      <div id="alt-hdr-right">

        <a href="node-red-access-data-in-postgres.html"><i class="fa fa-chevron-left mr-8"></i></a>


        <a href="../index.html"><i class="fa fa-home mr-8"></i></a>


        <a href="../search.html"><i class="fa fa-search mr-8"></i></a>



        <a href="postgrest-api.html"><i class="fa fa-chevron-right"></i></a>

      </div>
    </div>
  </div>

  <div id="content-row" class="row">
    <div id="page-content" class="col-md-12 flex-col">
      <div id="content-container">
        <div id="nav">
          
  <div class="navsidebar">
    <div id="sidebar-search">
      
<div class="input-group" title="Enter something to search for and then either press Enter or click the magnifying glass">
  <input type="text" class="form-control search-query" placeholder="Search docs ...">
  <div class="input-group-addon">
    <i class="fa fa-search"></i>
  </div>
</div>
    </div>
      <div class="sidebar-block">
        <div class="sidebar-tocheading">
          <div class="pull-left">
            <h2>Table Of Contents</h2>
          </div>
          <div class="pull-right" title="Hide this sidebar (hover at left edge to bring it back)"><i class="fa fa-chevron-left hidetoc"></i></div>
        </div>
        <div class="sidebar-toc">
      
        <div style="clear: both"></div>
      
        
  
    <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction/index.html#introduction">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation/index.html#installation">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../services/index.html#services">Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../utilities/index.html#utilities">Utilities</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html#osgs">Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../blueprints/index.html#blueprints">Blueprints</a></li>
<li class="toctree-l1"><a class="reference internal" href="../FAQ.html#troubleshooting-faq">Troubleshooting FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../roadmap.html#osgs-roadmap">OSGS Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Credits.html#credits">Credits</a></li>
</ul>

  
        </div>
      </div>
  </div>
        </div>
        <div id="content" tabindex="0" class="stretch">
          <div id="mnav">
            
  
    <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction/index.html#introduction">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation/index.html#installation">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../services/index.html#services">Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../utilities/index.html#utilities">Utilities</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html#osgs">Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../blueprints/index.html#blueprints">Blueprints</a></li>
<li class="toctree-l1"><a class="reference internal" href="../FAQ.html#troubleshooting-faq">Troubleshooting FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../roadmap.html#osgs-roadmap">OSGS Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Credits.html#credits">Credits</a></li>
</ul>

  
          </div>
          <div class="body">
            
  <div class="section" id="node-red-point-layer-to-world-map">
<h1>Node-red point layer to world map<a class="headerlink" href="#node-red-point-layer-to-world-map" title="Permalink to this heading">¶</a></h1>
<div class="section" id="deploy-the-node-red-service">
<h2>Deploy the Node-red service<a class="headerlink" href="#deploy-the-node-red-service" title="Permalink to this heading">¶</a></h2>
<div class="section" id="deploy-the-nginx-and-hugo-watcher-services">
<h3>Deploy the Nginx and Hugo Watcher services<a class="headerlink" href="#deploy-the-nginx-and-hugo-watcher-services" title="Permalink to this heading">¶</a></h3>
<p>To deploy the initial stack, which includes the  Nginx and Hugo Watcher services, please run either  <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">configure-ssl-self-signed</span></code> or <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">configure-letsencrypt-ssl</span></code>.</p>
</div>
<div class="section" id="deploy-the-postgres-and-postgis-service">
<h3>Deploy the Postgres and PostGIS service<a class="headerlink" href="#deploy-the-postgres-and-postgis-service" title="Permalink to this heading">¶</a></h3>
<p>Next, deploy the Postgres and PostGIS service using <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">deploy-postgres</span></code>. If you already have PostgreSQL already installed outside of the stack on your local machine, ensure that you specify a different Postgis Public Port number other than the default port, 5432. For example, you can use the port 5434.</p>
</div>
<div class="section" id="import-the-node-red-example-data-into-the-gis-database">
<h3>Import the Node-RED example data into the gis database<a class="headerlink" href="#import-the-node-red-example-data-into-the-gis-database" title="Permalink to this heading">¶</a></h3>
<p>In this workflow we will be creating a flow that get points and some data for each point from a table in a Postgres database, and pushes them through to the world map dashboard in Node-RED, to create a web map based on live data in the database.</p>
<p>The data we will be using in this workflow is the air quality data for capital cities around the world for different dates. The world capitals data is obtained from <a class="reference external" href="https://simplemaps.com/data/world-cities">Simplemaps.com</a> and the air quality data is obtained from <a class="reference external" href="https://www.weatherapi.com/">Weather API</a>). To import the example data into the gis database, run the following command <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">add-node-red-example-data</span></code>. To verify that the data has been imported, create a psql shell using <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">db-psql-shell</span></code> and run <code class="docutils literal notranslate"><span class="pre">\dn;</span></code> in the psql shell. The <code class="docutils literal notranslate"><span class="pre">gis</span></code> database should now contain the <code class="docutils literal notranslate"><span class="pre">weather-data-schema</span></code> and the <code class="docutils literal notranslate"><span class="pre">world_air_quality_schema</span></code> schemas as seen below:</p>
<p><img alt="Node-RED Example Data Schemas" src="../_images/node-red-postgres-table-1.png" /></p>
<p>The <code class="docutils literal notranslate"><span class="pre">world_air_quality_schema</span></code> should contain the following tables:</p>
<p><img alt="Node-RED Example Data Air quality Tables" src="../_images/node-red-worldmap-1.png" /></p>
</div>
<div class="section" id="id1">
<h3>Deploy the Node-RED Service<a class="headerlink" href="#id1" title="Permalink to this heading">¶</a></h3>
<p>Deploy the Node-RED service using <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">deploy-node-red</span></code>. To add the <code class="docutils literal notranslate"><span class="pre">node-red-contrib-postgres-multi</span></code> package to Node-RED, run <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">deploy-node-red-patch</span></code> then restart the service using <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">restart-node-red</span></code>.</p>
</div>
<div class="section" id="accessing-the-node-red-service">
<h3>Accessing the Node-RED Service<a class="headerlink" href="#accessing-the-node-red-service" title="Permalink to this heading">¶</a></h3>
<p>The Node-RED service can now be accessed on <code class="docutils literal notranslate"><span class="pre">/node-red/</span></code> e.g.  https://localhost/node-red. Use the <strong>NGINX_AUTH_USER</strong> and <strong>NGINX_AUTH_PWD</strong> specified in the <code class="docutils literal notranslate"><span class="pre">.env</span></code> file to sign in into the Node-RED editor.</p>
</div>
</div>
<div class="section" id="create-the-flow">
<h2>Create the Flow<a class="headerlink" href="#create-the-flow" title="Permalink to this heading">¶</a></h2>
<div class="section" id="install-the-non-default-nodes">
<h3>Install the non-default nodes<a class="headerlink" href="#install-the-non-default-nodes" title="Permalink to this heading">¶</a></h3>
<p>To get started, we will first install the worldmap node, which is not available by default in Node-RED. In the Header section of the Node-RED Editor, click on the main menu and select the <code class="docutils literal notranslate"><span class="pre">Manage</span> <span class="pre">Palette</span></code> option.</p>
<p><img alt="Manage Palette" src="../_images/node-red-postgres-table-3.png" /></p>
<p>Under the Palette tab of the User Settings dialog click on the Install tab. Search for the <code class="docutils literal notranslate"><span class="pre">node-red-contrib-web-worldmap</span></code> module using the search bar and install it by clicking the install button. Install the <code class="docutils literal notranslate"><span class="pre">node-red-dashboard</span></code> module in the same way. Once the modules have been installed, close the User Settings.</p>
<p><img alt="Install Worldmap Module" src="../_images/node-red-worldmap-2.png" /></p>
<p><img alt="Install Dashboard Module" src="../_images/node-red-worldmap-3.png" /></p>
</div>
<div class="section" id="obtain-dates-for-which-data-is-available">
<h3>Obtain dates for which data is available<a class="headerlink" href="#obtain-dates-for-which-data-is-available" title="Permalink to this heading">¶</a></h3>
<div class="section" id="add-nodes-to-workspace">
<h4>Add nodes to workspace<a class="headerlink" href="#add-nodes-to-workspace" title="Permalink to this heading">¶</a></h4>
<p>Drag and drop an inject node, 2 function nodes, a postgres node, a dropdown node and a debug node from the palette on the left of the workspace, onto the workspace.</p>
<p><img alt="Add Nodes" src="../_images/node-red-worldmap-5.png" /></p>
</div>
<div class="section" id="connect-to-the-gis-database">
<h4>Connect to the gis database<a class="headerlink" href="#connect-to-the-gis-database" title="Permalink to this heading">¶</a></h4>
<p>To configure the postgres node to connect to a database, double click on the first postgres node. This will open the node’s Edit dialog. Click on the pencil icon next to the Server Properties input box and specify the following properties:</p>
<table class="colwidths-auto">
<thead valign="bottom">
<tr class="row-odd"><th class="text-center head"><strong>Property</strong></th>
<th class="text-center head"><strong>Input</strong></th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td class="text-center">Host</td>
<td class="text-center">db</td>
</tr>
<tr class="row-odd"><td class="text-center">Port</td>
<td class="text-center">5432</td>
</tr>
<tr class="row-even"><td class="text-center">Database</td>
<td class="text-center">gis</td>
</tr>
<tr class="row-odd"><td class="text-center">Username</td>
<td class="text-center">docker</td>
</tr>
<tr class="row-even"><td class="text-center">Password</td>
<td class="text-center">&lt;POSTGRES_PASSWORD&gt;</td>
</tr>
</tbody>
</table>
<p>Use the POSTGRES_PASSWORD specified in the <code class="docutils literal notranslate"><span class="pre">.env</span></code> file. Please ensure you have enabled SSL by checking  <input type="checkbox" checked> Use SSL. Once your done with the configuration click on Add. In the Name input box specify the name of the node as <code class="docutils literal notranslate"><span class="pre">db</span></code>, check the <input type="checkbox" checked> Receive query output? box, then click on Done.</p>
<p><img alt="Configure the Postgres Node" src="../_images/node-red-postgres-table-6.png" /></p>
<p><img alt="Configure the Postgres Node" src="../_images/node-red-postgres-table-7.png" /></p>
</div>
<div class="section" id="query-the-gis-database-to-get-dates">
<h4>Query the <code class="docutils literal notranslate"><span class="pre">gis</span></code> database to get dates<a class="headerlink" href="#query-the-gis-database-to-get-dates" title="Permalink to this heading">¶</a></h4>
<p>There are five tables in the <code class="docutils literal notranslate"><span class="pre">world_air_quality_schema</span></code> schema. Each table has the  air quality data for the world’s capital cities observed on a specific date.</p>
<p><img alt="Node-RED Example Data Air quality Tables" src="../_images/node-red-worldmap-1.png" /></p>
<p>We will use the first function node to query the <code class="docutils literal notranslate"><span class="pre">gis</span></code> database we have connected to using the postgres node, to get the dates for which the data is available.</p>
<p><img alt="First Function Node" src="../_images/node-red-worldmap-9.png" /></p>
<p>To query the database we will need to assemble the following SELECT query: <code class="docutils literal notranslate"><span class="pre">SELECT</span>&#160; <span class="pre">replace(table_name,</span> <span class="pre">'air_quality_',</span> <span class="pre">'')</span> <span class="pre">FROM</span> <span class="pre">information_schema.tables</span> <span class="pre">WHERE</span> <span class="pre">table_schema='world_air_quality_schema'</span> <span class="pre">AND</span> <span class="pre">table_type='BASE</span> <span class="pre">TABLE'</span> <span class="pre">AND</span> <span class="pre">table_name</span> <span class="pre">LIKE</span> <span class="pre">'air_quality_%';</span></code> (adapted from <a class="reference external" href="https://stackoverflow.com/questions/14730228/postgresql-query-to-list-all-table-names">here</a>) as an array of objects on msg.payload using the function node. For more information on how to construct the above SELECT statement see:</p>
<ul class="simple">
<li><a class="reference external" href="https://www.postgresql.org/docs/current/infoschema-tables.html">tables</a></li>
<li><a class="reference external" href="https://www.postgresql.org/docs/current/sql-select.html">SELECT</a></li>
<li><a class="reference external" href="https://www.postgresqltutorial.com/postgresql-replace/">replace</a></li>
<li><a class="reference external" href="https://www.postgresql.org/docs/9.1/sql-select.html#SQL-WHERE">WHERE</a></li>
<li><a class="reference external" href="https://www.postgresql.org/docs/current/functions-logical.html">AND</a></li>
<li><a class="reference external" href="https://www.postgresql.org/docs/14/functions-matching.html#FUNCTIONS-LIKE">LIKE</a></li>
</ul>
<p>Double click on the function node to open the Edit dialog. Configure the function node as shown in the image below then click on Done.</p>
<p><img alt="Select Dates Function Node" src="../_images/node-red-worldmap-6.png" /></p>
</div>
<div class="section" id="display-the-dates-in-the-drop-down-menu">
<h4>Display the dates in the drop down menu<a class="headerlink" href="#display-the-dates-in-the-drop-down-menu" title="Permalink to this heading">¶</a></h4>
<p>To display the dates that data is available from the <code class="docutils literal notranslate"><span class="pre">world_air_quality_schema</span></code> schema in a drop down menu on the Node-RED dashboard, we will need to pass the dates as a list from the postgres node to the dropdown node. To do this, we will use the second function node to convert the msg.payload from the postgres node from an array to a list.</p>
<p><img alt="Second Function Node" src="../_images/node-red-worldmap-11.png" /></p>
<p>This is done using the JavaScript Array <a class="reference external" href="https://www.w3schools.com/jsref/jsref_foreach.asp"><code class="docutils literal notranslate"><span class="pre">forEach()</span></code></a> and <a class="reference external" href="https://www.w3schools.com/jsref/jsref_push.asp"><code class="docutils literal notranslate"><span class="pre">push()</span></code></a> methods.</p>
<p>Double click on the second function node to open the Edit dialog. Configure the function node as shown in the image below then click on Done.</p>
<p><img alt="Array to List Function Node" src="../_images/node-red-worldmap-7.png" /></p>
<p>To display the list of dates in a clickable drop down menu we will configure the dropdown node. Double click on the node to open the Edit dialog. Click on the pencil icon next to the Group input box and edit the Group properties as follows:</p>
<ul>
<li><p class="first">Add a new dashboard tab called <code class="docutils literal notranslate"><span class="pre">Air</span> <span class="pre">Quality</span></code>:</p>
<p><img alt="New Dashboard Tab " src="../_images/node-red-worldmap-12.png" /></p>
</li>
<li><p class="first">Name the group that the dashboard table will be assigned to as <code class="docutils literal notranslate"><span class="pre">Select</span> <span class="pre">Date</span></code>:</p>
</li>
</ul>
<p>  <img alt="New Dashboard Group " src="../_images/node-red-worldmap-13.png" /></p>
<p>Set the label as <code class="docutils literal notranslate"><span class="pre">Select</span> <span class="pre">Date</span></code> but leave the rest of the dropdown node’s properties as default and click on Done.</p>
<p><img alt="Dropdown Properties " src="../_images/node-red-worldmap-14.png" /></p>
<p>Connect the nodes in the flow as follows, click on Deploy then click on the inject node to manually trigger the flow:</p>
<p><img alt="Connect the flow " src="../_images/node-red-worldmap-10.png" /></p>
<p>The Node-RED dashboard display can now be accessed on <code class="docutils literal notranslate"><span class="pre">/ui/</span></code> e.g.  https://localhost/ui.</p>
<p>As seen in the image below, we now have a dropdown menu on our dashboard that allows us to select a date of interest to view the air quality data stored in the tables in the <code class="docutils literal notranslate"><span class="pre">world_air_quality_schema</span></code> schema for that specific date.</p>
<p><img alt="Air Quality Dashboard" src="../_images/node-red-worldmap-16.png" /></p>
<p>When we select a date from the dropdown menu, the dropdown node passes the date as the msg.payload to the debug node which displays the msg.payload on the debug console.</p>
<p><img alt="Message Payload" src="../_images/node-red-worldmap-17.png" /></p>
</div>
<div class="section" id="query-database-to-get-data-for-selected-date">
<h4>Query database to get data for selected date<a class="headerlink" href="#query-database-to-get-data-for-selected-date" title="Permalink to this heading">¶</a></h4>
<p>We will now use the date in the msg.payload from the drop down node to query the <code class="docutils literal notranslate"><span class="pre">gis</span></code> database to retrieve the <code class="docutils literal notranslate"><span class="pre">air_quality</span></code> table for that date.</p>
</div>
</div>
<div class="section" id="display-air-quality-data-for-the-date-selected-on-the-world-map">
<h3>Display air quality data for the date selected on the world map<a class="headerlink" href="#display-air-quality-data-for-the-date-selected-on-the-world-map" title="Permalink to this heading">¶</a></h3>
<p>In this step of the flow, we will display the air quality data for the world’s capital cities for the date selected on the world map.</p>
<div class="section" id="query-the-database-using-the-selected-date">
<h4>Query the database using the selected date<a class="headerlink" href="#query-the-database-using-the-selected-date" title="Permalink to this heading">¶</a></h4>
<p>Using a function node and a postgres node, we will use the date selected from the drop down menu (the msg.payload) to get the air quality table data for that specific date.</p>
<p>Add the 2 nodes and connect them as follows:</p>
<p><img alt="Add and Connect Nodes" src="../_images/node-red-worldmap-8.png" /></p>
<p>Label and Configure the function node as follows:</p>
<p><img alt="Label the Function Node" src="../_images/node-red-worldmap-18.png" /></p>
<p><img alt="Configure the Function Node" src="../_images/node-red-worldmap-15.png" /></p>
<p>For the postgres node, we will only set the Name property and check the <input type="checkbox" checked> Receive query output? box. The sever properties will by default, be the properties we configured in the first postgres node.</p>
<p><img alt="Configure the Postgres Node" src="../_images/node-red-worldmap-19.png" /></p>
<p>We can connect our postgres node to the debug node at this point and deploy the flow to check if our flow is working correctly. After manually triggering the flow using the inject node and selecting a date from the drop down menu, our debug console should have an output similar to this:</p>
<p><img alt="Debug Console Output" src="../_images/node-red-worldmap-20.png" /></p>
</div>
<div class="section" id="display-the-selected-data-on-the-world-map">
<h4>Display the selected data on the world map<a class="headerlink" href="#display-the-selected-data-on-the-world-map" title="Permalink to this heading">¶</a></h4>
<p>The table below shows the colours used to display the different Air Quality Index levels of concern. We will use these colours to display the air quality data on the world map.</p>
<p><img alt="Daily AQI Color" src="../_images/node-red-worldmap-21.png" /></p>
<p><em>Image Courtesy of <a class="reference external" href="https://www.airnow.gov/aqi/aqi-basics/">AirNow</a>.</em></p>
<p>We will assign a map icon and  and a map icon colour to each element of the msg.payload array from the previous section using a split node, a function node and a join node. The split node splits the message into individual array elements, the function node allows us to assign the map icon and map icon color message properties to each element, then the join node recombines the individual elements back into a single array.</p>
<p><img alt="Add and Connect Nodes" src="../_images/node-red-worldmap-4.png" /></p>
<p>Use the default configuration for the split and join nodes and configure the function node as follows:</p>
<p><img alt="Configure the Function Node" src="../_images/node-red-worldmap-22.png" /></p>
<p>After deploying our flow, we can see the icon and iconColor properties have been added to each individual element of the msg.payload array.</p>
<p><img alt="Add map icon and iconColor" src="../_images/node-red-worldmap-23.png" /></p>
<p>To display the data on the worldmap, add the worldmap node <img alt="Worldmap node" src="../_images/node-red-worldmap-24.png" /> from the dashboard category onto the workspace and connect it to the join node.</p>
<p>Double click on the node to open the Edit dialog. For the Group properties, add a new group called <code class="docutils literal notranslate"><span class="pre">Display</span> <span class="pre">Air</span> <span class="pre">Quality</span> <span class="pre">Data</span></code> to the Air Quality Dashboard Tab. Set the map’s start center coordinates 30 degrees latitude and 31 degrees longitude with a start zoom level of 4.</p>
<p><img alt="Add New Group" src="../_images/node-red-worldmap-25.png" /></p>
<p><img alt="Center the Map" src="../_images/node-red-worldmap-26.png" /></p>
<p>To change the layout of the dashboard, access the dashboard layout sidebar from the drop down menu on the sidebar to the right of the workspace. Click on the layout icon of the Air Quality Dashboard Tab.</p>
<p><img alt="Edit Dashboard Layout 1" src="../_images/node-red-worldmap-27.png" /></p>
<p><img alt="Edit Dashboard Layout 2" src="../_images/node-red-worldmap-28.png" /></p>
<p>Expand the world map.</p>
<p><img alt="Edit Dashboard Layout 2" src="../_images/node-red-worldmap-29.png" /></p>
</div>
</div>
<div class="section" id="deploy-and-run-the-flow">
<h3>Deploy and run the flow<a class="headerlink" href="#deploy-and-run-the-flow" title="Permalink to this heading">¶</a></h3>
<p>This is what your flow should look like:</p>
<p><img alt="Node-RED Flow" src="../_images/node-red-worldmap-30.png" /></p>
<p>Deploy and manually trigger your flow. On the Node-RED dashboard display, select a date from the drop down  menu and view the data on the worldmap.</p>
<p><img alt="View Dashboard" src="../_images/node-red-worldmap-31.png" /></p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="footer-row" class="row">

    <div class="col-md-12">
        <span></span><span class="pull-right">&copy; Copyright 2021, Tim Sutton.
        Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.0.2 and the
        <a href="https://pypi.org/project/sphinx-sizzle-theme/"

           title="0.0.9/821a5457 [2020-04-16T19:31:16]"

        >Sizzle</a> theme.</span>
    </div>

  </div>
</div>

<div id="tooltips" class="hidden">
</div>

<script>
$(document).ready(function() {
  'use strict';
  var $search = $('.search-query');

  var $nav = $('#nav');

  //$('#whole-page').removeClass('hidden');
  var nav_width = $nav.width();


  var search_url = '../search.html';

  function perform_search(e) {
    var $elem;

    if (e.type === 'keypress') {
      $elem = $(e.target);
    }
    else if (e.type === 'click') {
      $elem = $(e.target).parents('.input-group').find('input');
    }
    var q = $elem.val().trim();

    if (q) {
      var url = search_url + '?q=' + q + '&check_keywords=yes&area=default';

      location.href = url;
    }
  }



  $search.on('keypress', function(e) {
    if (e.which == 13) {
      perform_search(e);
    }
  });
  $search.parents('.input-group').find('.input-group-addon').on('click', perform_search);
  $(document).on('click', '.summary .fa-caret-right', function(e) {
    var $elem = $(e.target).parents('li');
    var $next = $elem.next();
    $elem.addClass('hidden');
    $next.removeClass('hidden');
  });
  $(document).on('click', '.detail .fa-caret-down', function(e) {
    var $elem = $(e.target).parents('li');
    var $prev = $elem.prev();
    $elem.addClass('hidden');
    $prev.removeClass('hidden');
  });

  $('#content').on('click', function() {
    $('#mnav').hide();
  });

  var counter = 0;
  var timer = null;

  function show_nav() {
    $('#content').off('mousemove', track_mouse);
    if (timer !== null) {
      clearTimeout(timer);
      timer = null;
    }
    $nav.show();
  }

  function track_mouse(e) {
    var x = e.clientX;

    if (x < 15) {
      ++counter;
      if (timer === null) {
        timer = setTimeout(show_nav, 2000);
      }
    }
    else {
      counter = 0;
    }
    if (counter >= 20) {
      show_nav();
    }
  };

  function hide_nav() {
    $nav.hide();
    counter = 0;
    $('#content').on('mousemove', track_mouse);
  }

  $('.hidetoc').on('click', hide_nav);

  $(document).on('keyup', function(e) {
    if (e.ctrlKey) {
      if (e.which == 37) {      // Ctrl+left arrow
        hide_nav();
      }
      else if (e.which == 39) { // Ctrl+right arrow
        show_nav();
      }
    }
  });

  $('.menu-toggle').on('click', function(e) {
    $('#mnav').toggle();
  });

  function scroll_nav(frag) {
    var sel = '#nav ' + (frag ? 'a[href="' + frag + '"]' : '.toctree-l1 a.current');

    var $link = $(sel);

    if ($link.length > 0) {
      $link[0].scrollIntoView({block: 'center'});
    }
  }

  // If the navigator is long, then the item we clicked on to get here might
  // not be in view. Try to scroll it into the view - a slight delay is needed
  // to get it to sync properly with other stuff going on (as the page has just
  // loaded). Hence the setTimeout with a timeout of 0.

  function do_scroll() {
    scroll_nav(window.location.hash);
  }

  setTimeout(do_scroll, 0);

  function adjust_size() {
    // we need to set the height explicitly so that scrolling regions in the
    // content area work properly.
    var h = $('#page-content').height();

    $('#nav, #content').height(h);
    if ($('#nav').is(':visible')) {
      $('#mnav').hide();
    }
  }

  adjust_size();

  $(window).on('resize', adjust_size);

  function focus_content() {
    $('#content').focus();  // so that keyboard can be used to scroll, etc.
  }

  setTimeout(focus_content, 150);

  var sizzle = $(document).data('sizzle');

  function make_tooltip(id, h, b) {
    var $e = $('<div>').attr('id', id);
    var $b = $('<div>').addClass('tc-body').html(b);

    if (h) {
      var $h = $('<div>').addClass('tc-heading').html(h);
      $e.append($h);
    }
    $e.append($b);
    return $e;
  }

  var default_tt_options = {
    theme: ['tooltipster-light', 'tooltipster-light-customized'],
    interactive: true,
    maxWidth: 600,
    contentCloning: true
  };

  function activate_tooltips() {
    var $tt = $('.tt');

    //console.log('tt links:', $tt.length);
    $tt.tooltipster(default_tt_options);
  }



  function add_glossary_tooltips() {
    var links = $('a');  // can qualify with .reference.internal
    var glinks = {};
    var pat = /(.*)\.html#(term-.*)$/;
    var found = false;  // links in this document

    $.each(links, function(i, link) {
        var $link = $(link);
        var href = $link.attr('href');
        var m = href.match(pat);

        if (m) {
          var s = m[1].replace(/^(\.\.\/)+/, '');

          if (s === sizzle.app_data.glossary.document) {
            var k = m[2];

            if (k in glinks) {
              glinks[k].push($link);
            }
            else {
              glinks[k] = [$link];
            }
            found = true;
          }
        }
    });
    if (found) {
      var $t = $('#tooltips');
      var data = sizzle.app_data.glossary.terms;

      $.each(glinks, function(k, v) {
        var d = data[k];

        if (d) {  // as a sanity check
          var s = 'tc-'+ k;
          var $e = make_tooltip(s, d.term, d.defn);
          $t.append($e);

          $.each(v, function(i, link) {
            link.addClass('tt').attr('data-tooltip-content', '#' + s);
          });
        }
      });
    }
  }

  if (sizzle.app_data && sizzle.app_data.glossary &&
      sizzle.app_data.glossary.document) {
    add_glossary_tooltips();
  }




  function add_custom_tooltips() {
    var info_tips = sizzle.app_data.custom_data['info-tips'] || {};

    if ($.isEmptyObject(info_tips)) {
      return;
    }

    var tt_options = $.extend({contentAsHTML: true}, default_tt_options);

    $('.tc-info').each(function() {
      var $elem = $(this).prev();
      var classes = $elem.attr('class');
      var m = /\btci-([\S]+)/.exec(classes);

      if (m !== null) {
        var key = m[1];

        if (key in info_tips) {
          var v = info_tips[key];
          var tt = $elem.tooltipster(tt_options).tooltipster('content', v);
        }
      }
    });
  }

  add_custom_tooltips();

  setTimeout(activate_tooltips, 1000);


  // Clipboard copy for code blocks with captions

  $('.code-block-caption').each(function() {
    var $cap = $(this);
    var $btn = $('<span class="clip-copy"><span class="copied hidden">Copied!</span><i class="fa fa-clipboard" title="Copy contents"></i></span>');
    var $code = $cap.parent().find('.highlight');

    $cap.append($btn);
    $btn.find('.fa-clipboard').data('clip-text', $code.text());
  });

  var clipboard = new ClipboardJS('.code-block-caption .fa-clipboard', {
    'text': function(trigger) {
      return $(trigger).data('clip-text');
    }
  });

  clipboard.on('success', function(e) {
    var $copied = $(e.trigger).prev();

    $copied.removeClass('hidden');

    setTimeout(function() {$copied.addClass('hidden'); }, 1000);
  });

  if (sizzle.on_load) {
    sizzle.on_load.forEach(function(f) {
      f();
    });
  }
});
</script>
</body>
</html>